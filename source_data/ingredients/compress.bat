@echo off
chcp 65001 > nul
powershell.exe -ExecutionPolicy Bypass -Command "Add-Type -AssemblyName System.Drawing; $dir='C:\Users\Administrator\Documents\claude过滤蔬菜图'; $target=200*1024; Write-Host 'Starting JPG Compression...'; Write-Host ''; $files=Get-ChildItem $dir -Filter *.jpg -File; Write-Host \"Total files: $($files.Count)\"; Write-Host ''; $c=0; $s=0; $tot=0; $tcs=0; foreach($f in $files) { $sz=$f.Length; $tot+=$sz; $szkb=[math]::Round($sz/1KB,1); if($sz -gt $target) { $c++; Write-Host \"[$c] $($f.Name) - $szkb KB\"; try { $img=[System.Drawing.Image]::FromFile($f.FullName); $codec=[System.Drawing.Imaging.ImageCodecInfo]::GetImageEncoders()|Where{$_.MimeType -eq 'image/jpeg'}; $p=New-Object System.Drawing.Imaging.EncoderParameters(1); $done=$false; for($q=75;$q-ge40;$q-=5) { $p.Param[0]=New-Object System.Drawing.Imaging.EncoderParameter([System.Drawing.Imaging.Encoder]::Quality,$q); $tmp=$f.FullName+'.tmp'; $img.Save($tmp,$codec,$p); $ns=(Get-Item $tmp).Length; if($ns -le $target) { $img.Dispose(); Remove-Item $f.FullName -Force; Rename-Item $tmp $f.FullName; $nskb=[math]::Round($ns/1KB,1); $pct=[math]::Round(($sz-$ns)/$sz*100,1); Write-Host \"    OK: $nskb KB (Q=$q, saved $pct pct)\"; $tcs+=$ns; $done=$true; break } else { Remove-Item $tmp -EA SI } }; if(-not $done) { $img.Dispose(); Write-Host \"    FAILED: could not reach target\"; $tcs+=$sz } } catch { Write-Host \"    ERROR: $_\"; $tcs+=$sz } } else { $s++; $tcs+=$sz; Write-Host \"  SKIP: $($f.Name) - $szkb KB\" } }; Write-Host ''; Write-Host '=== REPORT ==='; Write-Host \"Total: $($files.Count) | Compressed: $c | Skipped: $s\"; $omb=[math]::Round($tot/1MB,2); $cmb=[math]::Round($tcs/1MB,2); $sb=[math]::Round(($tot-$tcs)/1MB,2); $sp=[math]::Round(($tot-$tcs)/$tot*100,1); Write-Host \"Before: $omb MB | After: $cmb MB | Saved: $sb MB ($sp pct)\""
