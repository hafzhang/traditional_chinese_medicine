# Supervisor配置文件 - Claude Code 进程保活
# 防止进程意外退出，确保长期稳定运行

# 配置说明：
# 1. 将此文件复制到 /etc/supervisor/conf.d/claude.conf
# 2. 运行: sudo supervisorctl reread && sudo supervisorctl update
# 3. 启动: sudo supervisorctl start claude

[program:claude]
# 程序命令（根据实际启动方式修改）
command=bash -c 'cd /path/to/traditional_chinese_medicine && python -m claude_code'
# 或者使用其他启动方式：
# command=/usr/local/bin/claude-code --project-dir /path/to/project

# 运行用户
user=your_username

# 自动启动
autostart=true

# 自动重启
autorestart=true

# 启动延迟（秒）
startsecs=10

# 重试次数
startretries=3

# 退出信号
stopsignal=TERM

# 停止超时（秒）
stopwaittime=30

# 重定向标准输出
stdout_logfile=/var/log/supervisor/claude.stdout.log
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=10

# 重定向标准错误
stderr_logfile=/var/log/supervisor/claude.stderr.log
stderr_logfile_maxbytes=50MB
stderr_logfile_backups=10

# 环境变量
environment=
    PYTHONUNBUFFERED="1",
    CLAUDE_AUTONOMOUS_MODE="true",
    PROJECT_DIR="/path/to/traditional_chinese_medicine"

# 进程优先级（-20最高，19最低）
priority=10

# 运行目录
directory=/path/to/traditional_chinese_medicine

# 组名（用于批量管理）
groupname=claude_group

# 日志级别
loglevel=info

# 重定向到系统日志
redirect_stderr=false
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=10
stderr_logfile_maxbytes=50MB
stderr_logfile_backups=10

[program:claude_housekeeping]
# 日志清理任务（定时执行）
command=bash /path/to/traditional_chinese_medicine/scripts/hooks/house_keeping.sh

# 不自动启动（由cron触发）
autostart=false
autorestart=false

# 定时任务配置（通过cron）
# 0 0 * * * bash /path/to/scripts/hooks/house_keeping.sh
# 0 */6 * * * bash /path/to/scripts/hooks/token_guard.sh

[program:claude_token_guard]
# Token监控任务
command=bash /path/to/traditional_chinese_medicine/scripts/hooks/token_guard.sh

# 不自动启动
autostart=false
autorestart=false

# 依赖项
# priority=5  # 比主进程优先级高

# 组配置
[group:claude_apps]
programs=claude,claude_housekeeping,claude_token_guard
priority=999

# 全局配置
[supervisord]
logfile=/var/log/supervisor/supervisord.log
logfile_maxbytes=50MB
logfile_backups=10
loglevel=info
pidfile=/var/run/supervisord.pid
nodaemon=false
minfds=1024
minprocs=200

# RPC接口配置（可选）
# [unix_http_server]
# file=/var/run/supervisor.sock
# chmod=0700
#
# [supervisorctl]
# serverurl=unix:///var/run/supervisor.sock

# Web界面配置（可选）
# [inet_http_server]
# port=127.0.0.1:9001
# username=admin
# password=your_password
#
# [supervisorctl]
# serverurl=http://127.0.0.1:9001

# 事件监听器（可选）
# [eventlistener:stdout]
# command=/usr/local/bin/supervisor_stdout_listener
# events=PROCESS_LOG
# buffer_size=100
